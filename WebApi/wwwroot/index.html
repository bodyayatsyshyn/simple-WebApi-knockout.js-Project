<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Index</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.2.0/knockout-min.js"></script>
    <style>
        .tableContainer {
            width: 30em;
            margin: auto;
            padding: 1em;
            border: 5px solid black;
            border-radius: 25px;
            margin-bottom: 2em;
        }
        .crudBtns {
            margin-top: 1em;
        }
        body {
            background-image: url("https://www.transparenttextures.com/patterns/bedge-grunge.png");
            /* This is mostly intended for prototyping; please download the pattern and re-host for production environments. Thank you! */
        }
    </style>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.0/css/bootstrap.min.css" rel="stylesheet" />

</head>
<body>
<div id="mainContainer">
    <div style="margin: 2em">
        <table class="table table-striped table-bordered">
            <thead class="thead-dark">
                <tr>
                    <th>Invoice Id</th>
                    <th>Invoice number</th>
                    <th>Employee name</th>
                    <th>Date</th>
                    <th>Sum</th>
                </tr>
            </thead>
            <tbody data-bind="foreach: mainVM.DataArray" class="">
                <tr >
                    <td data-bind="text: Id"></td>
                    <td data-bind="text: InvoiceNumber"></td>
                    <td data-bind="text: EmployeeName"></td>
                    <td data-bind="text: Date"></td>
                    <td data-bind="text: Sum"></td>
                </tr>
            </tbody>
        </table>
        <div id="buttonContainer">
            <button id="EmployeeBtn" class="btn btn-primary" data-bind="click: mainVM.toggleEmployeeContainer">Employee</button>
            <button id="InvoiceBtn" class="btn btn-primary" data-bind="click: mainVM.toggleInvoiceContainer">Invoice</button>
            <button id="DetailsBtn" class="btn btn-primary" data-bind="click: mainVM.toggleDetailsContainer">Details</button>
        </div>
    </div>
    


    <div id="employeeContainer" class="tableContainer" data-bind="visible: mainVM.Visible.EmployeeContainer">
        <h2>Employees</h2>
        <table class="table table-bordered table-striped table-hover table-sm">
            <thead class="thead-dark">
            <tr>
                <th>Id</th>
                <th>Name</th>
                <th>Surname</th>
                <th>Date of birth</th>
            </tr>
            </thead>
            <tbody data-bind="foreach: employeeVM.Employees">
            <tr>
                <td data-bind="text: Id"></td>
                <td data-bind="text: Name"></td>
                <td data-bind="text: Surname"></td>
                <td data-bind="text: DateOfBirth"></td>
            </tr>
            </tbody>
        </table>
        <form style="width: 15em">
            <label for="employeeId">Id</label>
            <input class="form-control" type="number" data-bind="value: employeeVM.Id" id="employeeId" placeholder="Employee Id"/>
            <label for="employeeName">Name</label>
            <input class="form-control" type="text" data-bind="value: employeeVM.EmployeeName" id="employeeName" placeholder="Employee Name"/>
            <label for="employeeSurname">Surname</label>
            <input class="form-control" type="text" data-bind="value: employeeVM.EmployeeSurname" id="employeeSurname" placeholder="Employee Surname"/>
            <label for="employeeDateOfBirth">Date of birth</label>
            <input class="form-control" type="date" data-bind="value: employeeVM.DateOfBirth" id="employeeDateOfBirth"/>
        </form>
        <div class="crudBtns">
            <button data-bind="click: employeeVM.Create" class="btn btn-success">Create</button>
            <button data-bind="click: employeeVM.Update" class="btn btn-warning">Update</button>
            <button data-bind="click: employeeVM.Delete" class="btn btn-danger">Delete</button>
        </div>


    </div>

    <div id="invoiceContainer" class="tableContainer" data-bind="visible: mainVM.Visible.InvoiceContainer">
        <h2>Invoices</h2>
        <table class="table table-bordered table-striped table-hover table-sm">
            <thead class="thead-dark">
            <tr>
                <th>Id</th>
                <th>Number</th>
                <th>Date</th>
                <th>Sum</th>
                <th>Employee Name</th>
            </tr>
            </thead>
            <tbody data-bind="foreach: invoiceVM.Invoices">
            <tr>
                <td data-bind="text: Id"></td>
                <td data-bind="text: InvoiceNumder"></td>
                <td data-bind="text: Date"></td>
                <td data-bind="text: Sum"></td>
                <td data-bind="text: EmployeeName"></td>
            </tr>
            </tbody>
        </table>
        <form style="width: 15em">
            <label for="invoiceId">Id</label>
            <input type="number" data-bind="value: invoiceVM.Id" id="invoiceId" placeholder="Invoice Id" class="form-control"/>
            <label for="invoiceNumber">Invoice Number</label>
            <input type="text" data-bind="value: invoiceVM.InvoiceNumber" id="invoiceNumber" placeholder="Invoice Number" class="form-control"/>
            <label for="date">Date</label>
            <input type="datetime-local" data-bind="value: invoiceVM.Date" id="date" class="form-control"/>
            <label for="invoiceSum">Sum</label>
            <input type="text" data-bind="value: invoiceVM.Sum, enable: false" id="invoiceSum" class="form-control"/>
            <label for="invoiceEmployeeId">Employee</label>
            <select data-bind="options: invoiceVM.AvailableEmployees, optionsText: 'FullName', value: invoiceVM.SelectedEmployee" id="invoiceEmployeeId" class="form-control"></select>
        </form>
        <div class="crudBtns">
            <button data-bind="click: invoiceVM.Create" class="btn btn-success">Create</button>
            <button data-bind="click: invoiceVM.Update" class="btn btn-warning">Update</button>
            <button data-bind="click: invoiceVM.Delete" class="btn btn-danger">Delete</button>
        </div>
    </div>

    <div id="detailsContainer" class="tableContainer" data-bind="visible: mainVM.Visible.DetailsContainer">
        <h2>Details</h2>
        <table class="table table-bordered table-striped table-hover table-sm">
            <thead class="thead-dark">
            <tr>
                <th>Id</th>
                <th>Description</th>
                <th>Sum</th>
                <th>Invoice Number</th>
            </tr>
            </thead>
            <tbody data-bind="foreach: detailsVM.Details">
            <tr>
                <td data-bind="text: Id"></td>
                <td data-bind="text: Description"></td>
                <td data-bind="text: Sum"></td>
                <td data-bind="text: InvoiceNumber"></td>
            </tr>
            </tbody>
        </table>
        <form style="width: 15em">
            <label for="deteilsInvoiceId">Id</label>
            <input type="number" data-bind="value: detailsVM.Id" id="deteilsId" placeholder="Details Id" class="form-control"/>
            <label for="description">Description</label>
            <input type="text" data-bind="value: detailsVM.Description" id="description" placeholder="Description" class="form-control"/>
            <label for="detailsSum">Sum</label>
            <input type="number" data-bind="value: detailsVM.Sum" id="detailsSum" placeholder="Details Sum" class="form-control"/>
            <label for="deteilsInvoiceId">Invoice</label>
            <select data-bind="options: detailsVM.AvailableInvoices, optionsText: 'InvoiceNumber', value: detailsVM.SelectedInvoice" id="deteilsInvoiceId" class="form-control"></select>
        </form>
        <div class="crudBtns">
            <button data-bind="click: detailsVM.Create" class="btn btn-success">Create</button>
            <button data-bind="click: detailsVM.Update" class="btn btn-warning">Update</button>
            <button data-bind="click: detailsVM.Delete" class="btn btn-danger">Delete</button>
        </div>
    </div>
    
</div>

<script type="text/javascript">
    function RowItem(item) {
        this.Id = item.id;
        this.EmployeeName = item.employeeName;
        this.InvoiceNumber = item.invoiceNumber;
        this.Date = new Date(item.date).toLocaleString();
        this.Sum = item.sum;
    }

    function Employee(item) {
        this.Id = item.id;
        this.Name = item.name;
        this.Surname = item.surname;
        this.DateOfBirth = new Date(item.dateOfBirth).toLocaleDateString('en-GB');
    }

    function Invoice(item) {
        this.Id = item.id;
        this.InvoiceNumder = item.invoiceNumber;
        this.Date = new Date(item.executionDate).toLocaleString();
        this.Sum = item.sum;
        this.EmployeeName = item.employeeName;
    }

    function Details(item) {
        this.Id = item.id;
        this.Description = item.description;
        this.Sum = item.sum;
        this.InvoiceNumber = item.invoiceNumber;
    }

    function MainViewModel() {
        var self = this;


        self.DataArray = ko.observableArray([]);

        self.UpdateTable = function () {
            $.getJSON("/api/grid",
                function (data) {
                    var mappedData = $.map(data,
                        function (item) {
                            return new RowItem(item);
                        });
                    self.DataArray(mappedData);
                }
            );
        }

        self.UpdateTable();


        self.Visible = {
            EmployeeContainer: ko.observable(false),
            InvoiceContainer: ko.observable(false),
            DetailsContainer: ko.observable(false)
        }

        self.toggleEmployeeContainer = function () {
            self.Visible.EmployeeContainer(!self.Visible.EmployeeContainer());
            if (self.Visible.EmployeeContainer() == true) {
                self.Visible.DetailsContainer(false);
                self.Visible.InvoiceContainer(false);
            }
        }
        self.toggleInvoiceContainer = function () {
            self.Visible.InvoiceContainer(!self.Visible.InvoiceContainer());
            if (self.Visible.InvoiceContainer() == true) {
                self.Visible.DetailsContainer(false);
                self.Visible.EmployeeContainer(false);
            }
        }
        self.toggleDetailsContainer = function () {
            self.Visible.DetailsContainer(!self.Visible.DetailsContainer());
            if (self.Visible.DetailsContainer() == true) {
                self.Visible.InvoiceContainer(false);
                self.Visible.EmployeeContainer(false);
            }
        }
    }

    function EmployeeVW(mainVM, invoiceVM) {
        var self = this;
        self.Employees = ko.observableArray([]);
        self.UpdateTable = function () {
            $.getJSON("/api/employee",
                function (data) {
                    var mappedData = $.map(data,
                        function (item) {
                            return new Employee(item);
                        });
                    self.Employees(mappedData);
                }
            );
        }
        self.UpdateTable();

        self.Id = ko.observable();
        self.Id.subscribe(function (item) {
            self.Id(parseInt(item));
        });
        self.EmployeeName = ko.observable('');
        self.EmployeeSurname = ko.observable('');

        var currentDate = (new Date()).toISOString().split('T')[0];
        self.DateOfBirth = ko.observable(currentDate);

        self.MyDate = ko.computed(function() {
            var val = self.DateOfBirth();
            if (typeof val === 'string')
                val = new Date(val);
            return val;
        });
        self.MyDate.subscribe(function(item) {
            self.DateOfBirth();
        });

        var User =
        {
            Id: self.Id,
            Name: self.EmployeeName,
            Surname: self.EmployeeSurname,
            DateOfBirth: self.DateOfBirth
        }
        self.Create = function () {
            $.ajax({
                type: "POST",
                url: "/api/Employee",
                data: ko.toJSON(User), //Convert the Observable Data into JSON
                contentType: "application/json",
                success: function () {
                    alert("Record Added Successfully");
                    self.UpdateTable();
                    invoiceVM.UpdateAvailableEmployee();
                },
                error: function () {
                    alert("Failed");
                }
            });
            mainVM.UpdateTable();
        }
        self.Update = function () {
            $.ajax({
                type: "PUT",
                url: "/api/Employee/" + self.Id(),
                data: ko.toJSON(User), //Convert the Observable Data into JSON
                contentType: "application/json",
                success: function () {
                    alert("Record Updated Successfully");
                    self.UpdateTable();
                    invoiceVM.UpdateAvailableEmployee();
                    mainVM.UpdateTable();
                },
                error: function () {
                    alert("Failed");
                }
            });
        }
        self.Delete = function () {
            $.ajax({
                type: "DELETE",
                url: "/api/Employee/" + self.Id(),
                success: function () {
                    alert("Record Deleted Successfully");
                    self.UpdateTable();
                    invoiceVM.UpdateAvailableEmployee();
                    mainVM.UpdateTable();
                },
                error: function () {
                    alert("Failed");
                }
            });
        }
    }

    function InvoiceVM(mainVM, detailsVM) {
        var self = this;
        self.Invoices = ko.observableArray([]);
        self.UpdateTable = function () {
            $.getJSON("/api/invoice",
                function (data) {
                    var mappedData = $.map(data,
                        function (item) {
                            return new Invoice(item);
                        });
                    self.Invoices(mappedData);
                }
            );
        }
        self.UpdateTable();

        self.Id = ko.observable();
        self.Id.subscribe(function (item) {
            self.Id(parseInt(item));
        });
        self.InvoiceNumber = ko.observable('');

        var currentDate = (new Date()).toISOString().split('T')[0];
        self.Date = ko.observable(currentDate);
        self.MyDate = ko.computed(function() {
            var val = self.Date();
            if (typeof val === 'string')
                val = new Date(val);
            return val;
        });
        self.MyDate.subscribe(function(item) {
            self.Date();
        });

        self.Sum = ko.observable(0);
        self.EmployeeId = ko.observable(2);
        self.EmployeeId.subscribe(function (item) {
            self.EmployeeId(parseInt(item));
        });
        var InvoiceItem = {
            Id: self.Id,
            InvoiceNumber: self.InvoiceNumber,
            ExecutionDate: self.Date,
            Sum: self.Sum,
            EmployeeId: self.EmployeeId
        }

        function EmployeeView(item) {
            this.EmployeeId = item.id;
            this.FullName = item.name + ' ' + item.surname;
        }

        self.AvailableEmployees = ko.observableArray([]);
        self.UpdateAvailableEmployee = function () {
            $.getJSON("/api/employee",
                function (data) {
                    var mappedData = $.map(data,
                        function (item) {
                            return new EmployeeView(item);
                        });
                    self.AvailableEmployees(mappedData);
                }
            );
        }
        self.UpdateAvailableEmployee();
        self.SelectedEmployee = ko.observable();
        self.SelectedEmployee.subscribe(function (emp) {
            self.EmployeeId(emp.EmployeeId);
        });


        self.Create = function () {
            $.ajax({
                type: "POST",
                url: "/api/Invoice",
                data: ko.toJSON(InvoiceItem), //Convert the Observable Data into JSON
                contentType: "application/json",
                success: function () {
                    alert("Record Added Successfully");
                    self.UpdateTable();
                    mainVM.UpdateTable();
                    detailsVM.UpdateAvailableInvoices();
                },
                error: function () {
                    alert("Failed");
                }
            });
        }
        self.Update = function () {
            $.ajax({
                type: "PUT",
                url: "/api/Invoice/" + self.Id(),
                data: ko.toJSON(InvoiceItem), //Convert the Observable Data into JSON
                contentType: "application/json",
                success: function () {
                    alert("Record Updated Successfully");
                    self.UpdateTable();
                    mainVM.UpdateTable();
                    detailsVM.UpdateAvailableInvoices();
                },
                error: function () {
                    alert("Failed");
                }
            });
        }
        self.Delete = function () {
            $.ajax({
                type: "DELETE",
                url: "/api/Invoice/" + self.Id(),
                success: function () {
                    alert("Record Deleted Successfully");
                    self.UpdateTable();
                    mainVM.UpdateTable();
                    detailsVM.UpdateAvailableInvoices();
                },
                error: function () {
                    alert("Failed");
                }
            });
        }
    }

    function DetailsVM(mainVM) {
        var self = this;
        self.Details = ko.observableArray([]);
        self.UpdateTable = function () {
            $.getJSON("/api/details",
                function (data) {
                    var mappedData = $.map(data,
                        function (item) {
                            return new Details(item);
                        });
                    self.Details(mappedData);
                }
            );
        }
        self.UpdateTable();

        self.Id = ko.observable();
        self.Id.subscribe(function (item) {
            self.Id(parseInt(item));
        });
        self.Description = ko.observable();
        self.Sum = ko.observable();
        self.Sum.subscribe(function (item) {
            self.Sum(parseFloat(item));
        });
        self.InvoiceId = ko.observable();
        self.InvoiceId.subscribe(function (item) {
            self.InvoiceId(parseInt(item));
        });
        var DetailsItem = {
            Id: self.Id,
            Description: self.Description,
            //ExecutionDate: self.Date,
            Sum: self.Sum,
            InvoiceId: self.InvoiceId
        }

        function InvoiceView(item) {
            this.InvoiceId = item.id;
            this.InvoiceNumber = item.invoiceNumber;
        }

        self.AvailableInvoices = ko.observableArray([]);
        self.UpdateAvailableInvoices = function () {
            $.getJSON("/api/invoice",
                function (data) {
                    var mappedData = $.map(data,
                        function (item) {
                            return new InvoiceView(item);
                        });
                    self.AvailableInvoices(mappedData);
                }
            );
        }
        self.UpdateAvailableInvoices();
        self.SelectedInvoice = ko.observable();
        self.SelectedInvoice.subscribe(function (inv) {
            self.InvoiceId(inv.InvoiceId);
        });

        self.Create = function () {
            $.ajax({
                type: "POST",
                url: "/api/Details",
                data: ko.toJSON(DetailsItem), //Convert the Observable Data into JSON
                contentType: "application/json",
                success: function () {
                    alert("Record Added Successfully");
                    self.UpdateTable();
                    mainVM.UpdateTable();
                },
                error: function () {
                    alert("Failed");
                }
            });
        }
        self.Update = function () {
            $.ajax({
                type: "PUT",
                url: "/api/Details/" + self.Id(),
                data: ko.toJSON(DetailsItem), //Convert the Observable Data into JSON
                contentType: "application/json",
                success: function () {
                    alert("Record Updated Successfully");
                    self.UpdateTable();
                    mainVM.UpdateTable();
                },
                error: function () {
                    alert("Failed");
                }
            });
        }
        self.Delete = function () {
            $.ajax({
                type: "DELETE",
                url: "/api/Details/" + self.Id(),
                success: function () {
                    alert("Record Deleted Successfully");
                    self.UpdateTable();
                    mainVM.UpdateTable();
                },
                error: function () {
                    alert("Failed");
                }
            });
        }
    }


    function BindingBase() {

        this.mainVM = new MainViewModel();
        this.detailsVM = new DetailsVM(this.mainVM);
        this.invoiceVM = new InvoiceVM(this.mainVM, this.detailsVM);
        this.employeeVM = new EmployeeVW(this.mainVM, this.invoiceVM);
    }



    ko.applyBindings(new BindingBase());

</script>
</body>
</html>